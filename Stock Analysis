Sub AnalyzeStocks()
    Dim ws As Worksheet
    Dim lastRow As Long, lastSummaryRow As Long
    Dim ticker As String
    Dim openPrice As Double, closePrice As Double
    Dim quarterlyChange As Double, percentChange As Double
    Dim totalVolume As Double
    Dim summaryRow As Integer
    Dim quarterStartDate As Date, quarterEndDate As Date
    Dim greatestIncrease As Double, greatestDecrease As Double, greatestVolume As Double
    Dim tickerIncrease As String, tickerDecrease As String, tickerVolume As String
    
    ' Loop through all worksheets in the workbook
    For Each ws In ThisWorkbook.Worksheets
        ' Initialize variables
        lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
        summaryRow = 2
        totalVolume = 0
        greatestIncrease = 0
        greatestDecrease = 0
        greatestVolume = 0
        
        ' Add headers for summary table
        ws.Cells(1, 9).Value = "Ticker"
        ws.Cells(1, 10).Value = "Quarterly Change"
        ws.Cells(1, 11).Value = "Percent Change"
        ws.Cells(1, 12).Value = "Total Stock Volume"
        
        ' Initialize first ticker and quarter
        ticker = ws.Cells(2, 1).Value
        quarterStartDate = DateSerial(Year(ws.Cells(2, 2).Value), (DatePart("q", ws.Cells(2, 2).Value) - 1) * 3 + 1, 1)
        quarterEndDate = DateSerial(Year(quarterStartDate), Month(quarterStartDate) + 3, 0)
        openPrice = ws.Cells(2, 3).Value
        
        ' Loop through all rows
        For i = 2 To lastRow
            ' Check if we're still within the same stock and quarter
            If ws.Cells(i, 1).Value <> ticker Or ws.Cells(i, 2).Value > quarterEndDate Then
                ' Set the close price
                closePrice = ws.Cells(i - 1, 6).Value
                
                ' Calculate quarterly change and percent change
                quarterlyChange = closePrice - openPrice
                If openPrice <> 0 Then
                    percentChange = quarterlyChange / openPrice
                Else
                    percentChange = 0
                End If
                
                ' Print the summary row
                ws.Cells(summaryRow, 9).Value = ticker
                ws.Cells(summaryRow, 10).Value = quarterlyChange
                ws.Cells(summaryRow, 11).Value = percentChange
                ws.Cells(summaryRow, 12).Value = totalVolume
                
                ' Format percent change as percentage
                ws.Cells(summaryRow, 11).NumberFormat = "0.00%"
                
                ' Color code quarterly change
                If quarterlyChange > 0 Then
                    ws.Cells(summaryRow, 10).Interior.Color = RGB(0, 255, 0)
                ElseIf quarterlyChange < 0 Then
                    ws.Cells(summaryRow, 10).Interior.Color = RGB(255, 0, 0)
                End If
                
                ' Check for greatest increase, decrease, and volume
                If percentChange > greatestIncrease Then
                    greatestIncrease = percentChange
                    tickerIncrease = ticker
                ElseIf percentChange < greatestDecrease Then
                    greatestDecrease = percentChange
                    tickerDecrease = ticker
                End If
                
                If totalVolume > greatestVolume Then
                    greatestVolume = totalVolume
                    tickerVolume = ticker
                End If
                
                ' Reset variables for next stock/quarter
                summaryRow = summaryRow + 1
                totalVolume = 0
                ticker = ws.Cells(i, 1).Value
                quarterStartDate = DateSerial(Year(ws.Cells(i, 2).Value), (DatePart("q", ws.Cells(i, 2).Value) - 1) * 3 + 1, 1)
                quarterEndDate = DateSerial(Year(quarterStartDate), Month(quarterStartDate) + 3, 0)
                openPrice = ws.Cells(i, 3).Value
            End If
            
            ' Add to the total volume
            totalVolume = totalVolume + ws.Cells(i, 7).Value
        Next i
        
        ' Handle the last stock/quarter
        closePrice = ws.Cells(lastRow, 6).Value
        quarterlyChange = closePrice - openPrice
        If openPrice <> 0 Then
            percentChange = quarterlyChange / openPrice
        Else
            percentChange = 0
        End If
        
        ws.Cells(summaryRow, 9).Value = ticker
        ws.Cells(summaryRow, 10).Value = quarterlyChange
        ws.Cells(summaryRow, 11).Value = percentChange
        ws.Cells(summaryRow, 12).Value = totalVolume
        ws.Cells(summaryRow, 11).NumberFormat = "0.00%"
        
        If quarterlyChange > 0 Then
            ws.Cells(summaryRow, 10).Interior.Color = RGB(0, 255, 0)
        ElseIf quarterlyChange < 0 Then
            ws.Cells(summaryRow, 10).Interior.Color = RGB(255, 0, 0)
        End If
        
        ' Check for greatest increase, decrease, and volume one last time
        If percentChange > greatestIncrease Then
            greatestIncrease = percentChange
            tickerIncrease = ticker
        ElseIf percentChange < greatestDecrease Then
            greatestDecrease = percentChange
            tickerDecrease = ticker
        End If
        
        If totalVolume > greatestVolume Then
            greatestVolume = totalVolume
            tickerVolume = ticker
        End If
        
        ' Output the greatest increase, decrease, and volume at the beginning
        ws.Cells(2, 15).Value = "Greatest % Increase"
        ws.Cells(3, 15).Value = "Greatest % Decrease"
        ws.Cells(4, 15).Value = "Greatest Total Volume"
        ws.Cells(1, 16).Value = "Ticker"
        ws.Cells(1, 17).Value = "Value"
        
        ws.Cells(2, 16).Value = tickerIncrease
        ws.Cells(2, 17).Value = greatestIncrease
        ws.Cells(2, 17).NumberFormat = "0.00%"
        
        ws.Cells(3, 16).Value = tickerDecrease
        ws.Cells(3, 17).Value = greatestDecrease
        ws.Cells(3, 17).NumberFormat = "0.00%"
        
        ws.Cells(4, 16).Value = tickerVolume
        ws.Cells(4, 17).Value = greatestVolume
        
        ' Autofit columns
        ws.Columns("I:Q").AutoFit
    Next ws
    
    MsgBox "Analysis complete!"
End Sub
